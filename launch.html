<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launch SMART BP Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <h2>SMART BP Monitor</h2>
        <p>Connecting to EHR...</p>
        <div id="error" style="color: red; display: none;"></div>
    </div>

    <script>
        // SMART on FHIR EHR Launch
        // This page initiates the OAuth2 authorization flow

        // Taiwan MOHW Sandbox FHIR Server URL
        const MOHW_SANDBOX_ISS = "https://thas.mohw.gov.tw/v/r4/sim/WzIsIiIsIiIsIkFVVE8iLDAsMCwwLCIiLCIiLCIiLCIiLCIiLCIiLCIiLDAsMSwiIl0/fhir";

        // Clear any existing session data to force fresh login
        sessionStorage.clear();

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const forceReselect = urlParams.get('reselect') === 'true';
        const issFromUrl = urlParams.get('iss');

        // Build authorize options
        const authorizeOptions = {
            // Client ID - for sandbox testing, use a descriptive name
            // For production, you'll need to register with the EHR vendor
            clientId: "smart_bp_monitor",

            // Requested scopes
            // - launch: Support EHR launch context
            // - openid: OpenID Connect for user identity
            // - fhirUser: Get current user info
            // - patient/*.read: Read all patient resources
            // - patient/Observation.write: Write observations (for BP data)
            scope: "launch openid fhirUser patient/*.read patient/Observation.write",

            // Redirect to index.html after authorization
            redirectUri: "index.html"
        };

        // Always use MOHW sandbox as default if no ISS provided in URL
        // This ensures proper redirect to MOHW patient selection
        if (!issFromUrl) {
            authorizeOptions.iss = MOHW_SANDBOX_ISS;
        }

        FHIR.oauth2.authorize(authorizeOptions).catch(function(error) {
            // Display error if authorization fails
            document.getElementById("error").style.display = "block";
            document.getElementById("error").innerHTML =
                "<strong>Authorization Error:</strong><br>" +
                error.message +
                "<br><br><a href='index.html'>Continue in Demo Mode</a>" +
                "<br><br><a href='" + MOHW_SANDBOX_ISS.replace('/fhir', '') + "'>Go to MOHW Sandbox</a>";
        });
    </script>
</body>
</html>
